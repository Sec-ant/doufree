var encodeHTML=function(t){return t.replace(/\&/g,"&amp;").replace(/\"/g,"&quot;").replace(/\'/g,"&apos;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")};function deferred(){var t={done:[],fail:[]},e={done:function(i){return t.done.push(i),e},fail:function(i){return t.fail.push(i),e}};return{resolve:function(){for(var e,i=0;e=t.done[i++];)e.apply(this,arguments)},reject:function(){for(var e,i=0;e=t.fail[i++];)e.apply(this,arguments)},promise:e}}function asyncRequest(t,e,i){var n=deferred(),a=null,l=(i||"get").toLowerCase();return a=$.ajax({url:t,type:l,dataType:"json",data:"post"===l?$.extend(e,{ck:get_cookie("ck")}):e,error:function(t){n.reject(t)},success:function(t){n.resolve(t)}}),n.promise.abort=function(){a&&a.abort()},n.promise}var DOULIST_ADDITEM="/j/doulist/{doulist_id}/additem",DOULIST_REMOVEITEM="/j/doulist/{doulist_id}/removeitem",DOULIST_EDITITEM="/j/doulist/{doulist_id}/edititem",DOULIST_COMMENT="/j/doulist/{doulist_id}/poke",DOULIST_CREATE="/j/doulist/add",DOULIST_LIST="/j/doulist/cat",DOULIST_SEARCH="/j/doulist/search",DOULIST_SEARCH_SELF="/j/doulist/search_user_doulists",DOULIST_GET_ITEM_INFO="/j/doulist/get_item_info",SUBJECT_DOULIST_LIST="/j/doulist/subject_doulists",validateForm=function(t,e){var i,n=!0;for(var a in e)e.hasOwnProperty(a)&&(i=t.find(a),(n=e[a](i))&&validateForm.cleanError(i));return n};function doulistCustomeEvents(t){var e=t.node.find(".bn-cancel");t.node.bind("dialog-error",(function(i,n){t.setContent('<div class="doulist-submit-success"><p>'+n+'</p>       <div class="item-submit">         <span class="bn-flat"><input type="button" value="关闭" class="bn-cancel"></span>       </div>     </div>    ').update(),e.click((function(){t.close()})),setTimeout((function(){t.close()}),3e3)})),t.node.bind("dialog-success",(function(i,n){title=n.__title||"添加成功",action=n.__action||'已经添加到<a href="'+n.url+'" target="_blank"> '+n.name+"</a>",t.setTitle(title).setContent('<div class="doulist-submit-success">       <i></i>'+action+'       <div>         <p>窗口将在<b class="num">3</b>秒后关闭</p>         <span class="bn-flat"><input type="button" value="关闭" class="bn-cancel"></span>       </div>     </div>    '),(e=t.node.find(".bn-cancel")).click((function(){t.close(),l&&clearTimeout(l)}));var a,l,s=t.node.find(".num"),d=s.text();!function(){a=a||arguments.callee,l=setTimeout((function(){s.text(--d),d?a():t.close()}),1e3)}()}))}validateForm.displayError=function(t,e){if(t){var i=t.closest(".item"),n=i.find(".form-field-error");0===n.length&&(n=$('<div class="form-field-error"></div>').prependTo(i)),n.show().html(e)}},validateForm.cleanError=function(t){t.closest(".item").find(".form-field-error").hide()};var doulistDialogForm=void 0===doulistDialogForm?{}:doulistDialogForm;doulistDialogForm.initForm=function(t){var e=t.node.find("form");e.submit((function(i){i.preventDefault();var n={subjectId:e.find("input[name=subject_id]").val(),subjectKind:e.find("input[name=subject_kind]").val(),subjectUrl:e.find("input[name=subject_url]").val(),subjectIsUrlSubject:"true"==e.find("input[name=subject_is_url_subject]").val(),comment:e.find('textarea[name="comment"]').val(),sync:e.find("#dlg-opt-share").attr("checked")?"1":""};(function(t,e,i){var n=e.find("input[name=dl_id]:checked"),a=n.val(),l=n.next().find("b").text(),s={".dl_exist_select input:checked":function(t){return!!t.length||(validateForm.displayError($(".dl_exist_select"),"请选择一个豆列"),!1)}};if(!a&&!0===window.hasCancelCollectAction){var d={__title:"取消收藏成功",__action:"已经取消了收藏"};return setTimeout((function(){e.trigger("form-submit-success",d)}),500),window.update_collect_state&&window.update_collect_state(!1),window.hasCancelCollectAction=null,e}if(validateForm(e,s)){var o={sid:i.subjectId,skind:i.subjectKind,comment:i.comment,sync_to_mb:i.sync};i.subjectIsUrlSubject&&(o.surl=i.subjectId,delete o.sid,delete o.skind),asyncRequest(DOULIST_ADDITEM.replace("{doulist_id}",a),o,"post").done((function(t){t.r?e.trigger("form-submit-error",t.err):(t.sid=i.subjectId,t.doulist_id=a,t.name=$.trim(encodeHTML(l)),window.update_collect_state&&window.update_collect_state(!0),e.trigger("form-submit-success",t))}))}return e})(0,e,n).bind("form-submit-error",(function(e,i){t.node.trigger("dialog-error",i)})).bind("form-submit-success",(function(e,i){t.node.trigger("dialog-success",i)}))})),e.bind("form-submit-fail",(function(t,i){validateForm.displayError(e.find("input[name=dl_title]"),i)})),doulistCustomeEvents(t)},function(t){var e;window.hasCancelCollectAction=null;var i=window.collect_target||{};i.limit||(i.limit=10),i.start=0;var n,a,l={tkind:i.tkind,tid:i.tid,start:0,limit:i.limit},s={start:0,limit:i.limit},d="",o="",c="",r=!1,u="",m=!1,f=!1,p='<div class="dl-item-wrap" data-category="{{category}}" data-doulist-type="{{doulist_type}}" data-is-syncing-from-note="{{is_syncing_from_note}}" data-sync-note-id="{{sync_note_id}}">  <input type="radio" value="{{id}}" id="{{id}}" name="dl_id">   <label for="{{id}}">     <span>{{count}}</span>     <b data-is-private="{{is_private}}">       <i data-id="{{id}}" data-name="{{name}}" data-is-collected="{{is_collected}}" class="cancel-collect-btn"></i>       {{name}}     </b>   </label> </div>',v='<div class="loading" style="float: none; width: auto; margin: 4px; background-position: center center;"></div>';var _={movie:"片单",tv:"片单",book:"书单"};function h(t){return t&&_[t]?_[t]:""}function g(n,a){!function(t){e&&e.close();t.picture=t.picture||"/pics/doulist_article.png";var n="1001"===t.cate?'<h3>选择书单</h3>  <input type="button" name="dl_choose" id="dl_new" autocomplete="off" class="lnk-flat" value="创建书单" />':"1002"===t.cate?'<h3>选择片单</h3>  <input type="button" name="dl_choose" id="dl_new" autocomplete="off" class="lnk-flat" value="创建片单" />':'<h3>选择豆列</h3>  <input type="button" name="dl_choose" id="dl_new" autocomplete="off" class="lnk-flat" value="创建豆列" />',a="1001"===t.cate?"输入新书单名称":"1002"===t.cate?"输入新片单名称":"输入新豆列名称",u=e=dui.Dialog({title:"1002"===t.cate?"添加到片单":"1001"===t.cate?"添加到书单":"收藏到豆列",width:640,cls:"dialog-doulist",content:("False"===t.canview?'<div class="doulist-ft" style="text-align:left;">啊，该内容你没有权限查看或已被作者删除。</div>':'<form action="" method="post">        <div class="doulist-bd">          <div class="doulist-preview">            <div><img src="{{picture}}" /></div>            <p class="item-title">{{title}}</p>          </div>          <div class="doulist-content">            <div class="item">              <div class="item-hd">                <input type="text" name="search" class="dl_search" autocomplete="off" placeholder="请输入豆列名称" maxlength="40" />                <a href="javascript: void 0;" class="clear_search">×</a>'+n+'</div>              <div class="dl-bd">                <div class="dl-item">                  <div class="dl_new_title" style="display: none;">                    <div class="dl_title_block">                       <input id="dl_title" type="text" class="basic-input dl-title" placeholder="'+a+'" maxlength="40" />                    </div>                     <div class="dl_action_block">                       <div class="dl_create_option">                        <span>隐私设置：</span>                         <input id="doulist_is_not_secret" type="radio" name="is_private" value="false" checked />                         <label for="doulist_is_not_secret">所有人可见</label>                         <input id="doulist_is_secret" type="radio" name="is_private" value="true" />                         <label for="doulist_is_secret">仅自己可见</label>                       </div>                       <input type="button" class="lnk-flat dl_new_submit" disabled value="创建" />                    </div>                   </div>                </div>                <div class="dl-loading">                  加载中...                </div>              </div>            </div>            <div class="item">              <div class="item-hd">                <h3>推荐语<span>（选填）</span></h3>              </div>              <textarea id="doulist_item_comment" class="basic-textarea" name="comment" placeholder="告诉大家你添加它的理由吧"></textarea>            </div>            <input type="hidden" name="dl_cat" value="{{cate}}">            <input type="hidden" name="subject_id" value="{{id}}">            <input type="hidden" name="subject_kind" value="{{cate}}">            <input type="hidden" name="subject_url" value="{{url}}">            <input type="hidden" name="subject_is_url_subject" value="{{isurlsubject}}">            </div>          </div>          <div class="doulist-ft">            <a target="_blank" href="http://www.douban.com/service/bookmarklet" class="lnk-bookmarklet">小工具：从浏览器直接把网页内容加入豆列</a>            <span class="bn-flat cancel_btn"><input type="button" class="j_close_dialog" value="取消"></span>            <span class="bn-flat"><input type="submit" class="doulist_submit" value="保存"></span>          </div>      </form>    ').replace(/{{[^{}]+}}/g,(function(e){return encodeHTML(t[e.replace(/[{}]/g,"")]+"").toString()}))},!0).open();u.update(),u.node.bind("dialog:close",(function(){u.node.remove()})),u.node.bind("dialog:change",(function(){u.update()})),i.tkind=t.cate,i.tid=t.id,i.start=0,l.tkind=t.cate,l.tid=t.id,l.start=0,s.start=0,d="",o="",c="",r=!1,k()}(a),n.trigger("dialog:show",e),b(a,(function(){!function(e){var i=t("#dl_new"),n=t(".dl_new_title"),a=t("#dl_title"),l=t(".dl-item-exist");t("#dl_id");i.click((function(){var s=t(".form-field-error");if(n.is(":hidden"))s.show()&&i.val("取消创建"),n.slideDown((function(){l.addClass("fold"),a.focus()}));else{var d="1001"===e.cate?"书单":"1002"===e.cate?"片单":"豆列";s.hide()&&n.hide()&&i.val("创建"+d)&&l.removeClass("fold")}})),l.bind("scroll",(s=function(i){t(this).scrollTop()+t(this).height()+30>=t(".dl_exist_select:visible").height()&&(i.preventDefault(),l.find(".search-result-list").size()>0&&""!==c?j(e,!0):b(e))},d=300,function(){var t=this,e=arguments,i=o&&!r;clearTimeout(r),r=setTimeout((function(){r=null,o||s.apply(t,e)}),d),i&&s.apply(t,e)}));var s,d,o,r}(a),function(i){var n=e,a=t(".dl_new_title"),l=t("#dl_title"),s=t(".dl_new_submit");l.bind("keyup change",(function(){t.trim(l.val()).length?s.removeAttr("disabled"):s.attr("disabled",!0)})),l.bind("keydown",(function(t){if(13===t.keyCode)return S(n,a,i),!1})),s.click((function(){S(n,a,i)}))}(a),function(e){var i=t(".dl_search"),n=t(".dl-item-exist"),a=t(".dl_new_title"),l=t("#dl_new");t(".clear_search").click((function(){i.val("").change(),k()})),i.focus((function(){if(t(this).addClass("expand"),!a.is(":hidden")){var i=t(".form-field-error"),s="1001"===e.cate?"书单":"1002"===e.cate?"片单":"豆列";i.hide()&&a.hide()&&l.val("创建"+s)&&n.removeClass("fold")}})),i.bind({compositionstart:function(){f=!0},compositionend:function(){f=!1},input:function(){setTimeout((()=>{if(!f){var n=t.trim(i.val());n.length&&u!==n?(m=!1,j(e)):0===n.length&&k()}}),100)}})}(a),function(e){t(".cancel-collect-btn").click((function(i){if(i.stopPropagation(),i.preventDefault(),confirm("确定要移除吗？")){var n=t(this).attr("data-id"),a=DOULIST_REMOVEITEM.replace("{doulist_id}",n),l=window.collect_target||{},s=t(this);l.ck=get_cookie("ck"),l.tkind=e.cate,l.tid=e.id,asyncRequest(a,l,"post").done((function(t){if(0===t.r){s.attr("data-is-collected","false"),s.closest("label").find("span").html("");var e=s.closest("label").parent();e.find('input[type="radio"]').get(0).checked=!1,e.find('input[type="radio"]').attr("disabled",!1),e.removeClass("checked_dl"),window.hasCancelCollectAction=!0}else alert("取消收藏时遇到了错误: "+t.err)}))}}))}(a),function(i){var n=e;n.node.delegate(":radio","change",(function(){var e=t(this);if(!(e.parents(".dl_create_option").size()>0)){var a=e.val(),l=DOULIST_COMMENT.replace("{doulist_id}",a);e.parent().attr("data-is-syncing-from-note")||asyncRequest(l,{sid:i.id,skind:i.cate}).done((function(t){n.node.find("form #doulist_item_comment").val(t.comment)})).fail((function(){}))}}))}(a)})),doulistDialogForm.initForm(e)}function b(t,e){"1001"===t.cate?y("book",e):"1002"===t.cate?y("movie",e):y("common",e)}function y(s,c){var u=function(){l.start>=a||"pending"===o||(o="pending",t(".dl_exist_select").append(v),asyncRequest(DOULIST_LIST,{tkind:l.tkind,tid:l.tid,start:l.start,limit:l.limit}).done((function(i){var n=p;if(0===l.start&&"common"===s)if(i.total){var d='<div class="dl_exist_select">';t(i.doulist).each((function(t,e){d+=n.replace(/{{[^{}]+}}/g,(function(t){var i=e[t.replace(/[{}]/g,"")];return i&&encodeHTML(i.toString())||""}))})),d+="</div>",t("<div />",{class:"dl-item dl-item-exist"}).insertAfter(t(".dl-item")).append(d)}else t("<div />",{class:"dl-item dl-item-exist"}).insertAfter(t(".dl-item")).append('<div class="dl_exist_select"><div class="empty-list">还未创建豆列</div></div>');else{d="";t(i.doulist).each((function(t,e){d+=n.replace(/{{[^{}]+}}/g,(function(t){var i=e[t.replace(/[{}]/g,"")];return i&&encodeHTML(i.toString())||""}))})),t(".dl_exist_select").append(d)}l.start=l.start+l.limit,a=i.total,o="success",t(".dl-item-exist .loading").remove(),w(s),e.node.find("form #doulist_item_comment").val(i.comment),l.start>=a&&t(".dl_exist_select").append('<div style="padding: 14px 0; text-align: center; color: #666;">没有更多了</div>'),"common"===s&&c&&c()})).fail((function(){t(".dl-loading").text("+_+ 加载失败，请刷新重试"),o="error",t(".dl-item-exist .loading").remove()})))};r||"common"===s?u():i.start>=n||"pending"===d||(d="pending",t(".dl_exist_select").append(v),asyncRequest(SUBJECT_DOULIST_LIST,{start:i.start+x(),limit:i.limit,tkind:i.tkind,tid:i.tid}).done((function(a){var o=p;if(0===i.start)if(a.total){var m='<div class="dl_exist_select">';t(a.doulist).each((function(t,e){m+=o.replace(/{{[^{}]+}}/g,(function(t){var i=e[t.replace(/[{}]/g,"")];return i&&encodeHTML(i.toString())||""}))})),m+="</div>",t("<div />",{class:"dl-item dl-item-exist"}).insertAfter(t(".dl-item")).append(m)}else{var f="book"===s?"书单":"movie"===s?"片单":"";t("<div />",{class:"dl-item dl-item-exist"}).insertAfter(t(".dl-item")).append('<div class="dl_exist_select"><div class="empty-list">还未创建'+f+"</div></div>")}else{m="";t(a.doulist).each((function(t,e){m+=o.replace(/{{[^{}]+}}/g,(function(t){var i=e[t.replace(/[{}]/g,"")];return i&&encodeHTML(i.toString())||""}))})),t(".dl_exist_select").append(m)}t(".dl_new_title").hide(),i.start=i.start+i.limit,n=a.total,d="success",t(".dl-item-exist .loading").remove(),w(s),e.node.find("form #doulist_item_comment").val(a.comment),c&&c(),i.start>=n&&(r=!0,0===l.start&&t(".dl_exist_select").append('<div class="test" style="font-size: 15px; padding-top: 15px; margin: 10px 0; color: #666; border-top: 1px solid #DFDFDF; ">收藏到豆列</div>'),u())})).fail((function(){t(".dl-loading").text("+_+ 加载失败，请刷新重试"),d="error",t(".dl-item-exist .loading").remove()})))}function w(i,n){var a=e;(n?a.node.find(".search-result-list .dl-item-wrap"):a.node.find(".dl_exist_select .dl-item-wrap")).each((function(e,n){var a=t(n),l=a.attr("data-category"),s=(a.attr("data-doulist-type"),a.attr("data-is-syncing-from-note")),d=a.attr("data-sync-note-id"),o=a.find(".cancel-collect-btn").attr("data-is-collected");if(s&&a.find("input").attr("disabled",!0),s&&d&&i===l){var c=o?"去移除":"去添加";a.find("span").html('<a target="_blank" href="//www.douban.com/note/'+d+'/edit">'+c+"&gt;</a>")}}))}function x(){var e=t(".dl_exist_select"),i=0;return e.find(".dl-item-wrap").each((function(e,n){t(n).hasClass("just-created")&&i++})),i}function k(){var e=t(".dl_search"),i=t(".dl-item-exist"),n=t(".clear_search");t(".no-match-warning").hide(),i.find(".dl_exist_select").show(),i.find(".search-result-list").remove(),s.start=0,null,c="",n.hide(),e.val(""),u="",currenKeyword="",m=!1}function T(){var e=t(".dl-item-exist");t(".no-match-warning").length?t(".no-match-warning").show():e.before('<p class="no-match-warning">没有找到匹配结果，可以换个关键词试试</p>')}function j(e,i){var n=null,a=t(".dl_search"),l=t(".dl-item-exist"),d=(t(".dl_new_title"),t("#dl_new"),t(".clear_search")),o=t.trim(a.val());if(n&&n.abort(),"pending"===c||m)return;t(".no-match-warning").hide(),i||l.find(".search-result-list").remove(),d.hide(),a.addClass("loading"),u=o,c="pending";const r="1001"===e.cate?"book":"1002"===e.cate?"movie":"";(n=asyncRequest(DOULIST_SEARCH_SELF,{limit:5,start:i?s.start:0,q:o,category:r})).done((function(e){a.removeClass("loading"),d.show(),c="success",i&&(s.start=s.start+s.limit),e&&e.doulists&&e.doulists.length>0?(0===t(".dl-item-exist .search-result-list").size()&&t(".dl-item-exist .dl_exist_select").hide().after('<div class="search-result-list dl_exist_select"></div>'),function(e,i){var n=p;n=n.replace(/value="{{id}}" id="{{id}}"/g,'value="{{id}}" id="search-{{id}}"').replace(/for="{{id}}"/g,'for="search-{{id}}"');var a="";t(e.doulists).each((function(t,e){a+=n.replace(/{{[^{}]+}}/g,(function(t){var i=e[t.replace(/[{}]/g,"")];return i&&encodeHTML(i.toString())||""}))})),t(".dl-item-exist .search-result-list").append(a),w(i,!0)}(e,r)):(m=!0,0===s.start?(l.find(".dl_exist_select").hide(),l.find(".search-result-list").remove(),T()):l.find(".search-result-list").append('<div style="padding: 14px 0; text-align: center; color: #666;">没有更多了</div>'))})).fail((function(){m=!0,l.find(".dl_exist_select").hide(),l.find(".search-result-list").remove(),T(),a.removeClass("loading"),d.show(),c="error"}))}function S(e,i,n){var a,l,s=t("#dl_title"),d=t("#dl_new"),o=t(".dl_exist_select"),c={"#dl_title":function(t){if(""===t.val()){var e="1001"===n.cate?"书单":"1002"===n.cate?"片单":"豆列";return validateForm.displayError(t,"请给你的"+e+"起一个名称"),!1}return!0}};if(validateForm(i,c)){var r=t(".dl_new_submit");r.attr("disabled",!0);var u=t.trim(t("#dl_title").val()),m="1001"===n.cate?"book":"1002"===n.cate?"movie":"",f=h(m)+"｜";m&&(a=u,l=m,!["｜","丨","|"].some((t=>new RegExp("^"+h(l)+"\\"+t).test(a))))&&(u=f+u);var p={title:u,is_private:t('input[name="is_private"]:checked').val()};"1001"!==n.cate&&"1002"!==n.cate||(p.category="1001"===n.cate?"book":"movie"),asyncRequest(DOULIST_CREATE,p,"post").done((function(e){if(e.r)alert(e.err);else{e.doulist_id=e.id;var i='<div class="just-created dl-item-wrap"><input type="radio" value="{{id}}" id="{{id}}" name="dl_id" checked="checked"><label for="{{id}}"><b data-is-private="{{is_private}}">{{name}}</b></label></div>'.replace(/{{[^{}]+}}/g,(function(t){var i=e[t.replace(/[{}]/g,"")];return i&&encodeHTML(i.toString())||""}));t(i).prependTo(o),o.find(".empty-list").remove(),o.animate({scrollTop:0},100),d.click(),s.val("").change()}})).fail((function(){alert("网络问题，请稍后重试"),r.removeAttr("disabled")}))}else e.update();return i}t.fn.doulistDialog=function(e){return new g(t(this),e)}}(jQuery);